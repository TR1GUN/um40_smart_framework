# UM40 SMART Framework

Здесь расположен фреймворк для работы с модулями UM-40 SMART.

## :ok_woman: Как это работает 
    
С помощью этого фреймворка можно отправлять JSON в нужный модуль.

В командной строке через `echo` выполняется команда которая, шлет в stdin модуля нужный JSON

## :haircut: Прописывание настроек 

Перед запуском необходимо нахождение в корне проекта файла `settings.ini` в котором прописаны необходимые переменные.

Файл _settings.ini_ Должен находиться в корневой директории проекта, что использует фреймворк,
А так же должен содержать следующие прописанные переменные

- `IP_address` - IP адрес устройства
- `IP_port` - Порт сервера с которым происходит взаимодействие
- `user_login` - Логин пользователя с правами root от лица которого выполняется команда
- `user_password` - Пароль от этого пользователя
- `domain` - Домен виртуальной машины
- `machine_name` - Имя виртуальной машины

#### :bow: Пример:
```ini
[Test]
IP_address = 192.168.0.1
IP_port = 22
user_login = pi
user_password = pi
domain = smart-VirtualBox
machine_name = smart
```

## :information_desk_person: Как это запускать :


В корне проекта `UM40_SMART_Framework` есть функция `Setup()` через нее происходит все взаимодействие.

Для начала надо ее импортировать 

```python
from UM40_SMART_Framework import Setup
```
Сама функция принимает 3 аргумента - 

- JSON -`dict|str` - САМ JSON что запускаем. Допустимый формат - сразу строка JSON или словарь, который автоматически будет преобразован в JSON.  
- API -`str` - Имя API или полный путь до нее. Поддерживаемые имена API указаны ниже. 
- type_connect -`str` - тип соединения с УСПД. поддерживаемые типы соединений указаны ниже

Функция возвращает ответ от API или же ошибку в работе самого фреймворка.

### :boom: Поддержанные значения имен API

- `meterdev`  - API для взаимодействия со счетчиками
- `meter_db_data_api`  - API для взаимодействия с БД в которой хранятся снятые показания со счетчиков
- `meter_db_settings`  - API для взаимодействия с БД в которой хранятся настройки
- `uspd-meter_daemon`  - Здания в топик Демона опроса счетчиков — Не возвращает ответа
- `event_db_api`  - API для взаимодействия с БД системы событий
- `messenger_db_api`  - для работы с БД настроек брокеров MQTT и аккаунтов SMTP
- `iec60870_db_api`  - API для взаимодействия с БД iec60870
- `charge_stations_db_api`  - API для взаимодействия с БД зарядных станций


### :collision: Поддержанные значения имен способов связи с УСПД
- `tcp\ip`  - Запуск в запущенный TCP сервер на УСПД
- `docker`  - Запуск в Docker контейнер образа УСПД
- `virtualbox`  - Запуск в виртуальную машину образа УСПД
- `linux`  - Запуск внутри Linux системы
- `inside_launcher`  - Запуск внутри Linux системы
- `ssh`  - Запуск через SSH соединение 

Подробнее о каждом из способов запуска в разделе **Способы связи с компонентом**
## :massage: Пример запуска

```python
# Импортируем модуль
from UM40_SMART_Framework import Setup

# Формируем JSON
JSON = {"method":"get", "table": "MeterTable"}

# Отправляем JSON в нужную нам API 
answer = Setup(JSON=JSON, API="meter_db_settings", type_connect='ssh')
```
Где переменная - `answer` содержит ответ от самой УСПД

## :no_good: Зависимости :
- Для Работы с фреймворком в корне проекта обязательно должен быть файл `settings.ini`

ВСЕ сторонние библиотеки прописаны в файле `requirements.txt` и при импортировании должны подтягиваться автоматически 
Однако для ручной установки библиотек необходимо:

- API для Docker
	- Команда чтоб установить :
	```bash
	pip install docker
	```
- Библиотека для работы по SSH 
	- Команда чтоб установить :
	```bash
	pip install paramiko
	```
- Библиотека для работы с Virtual Box.

	- Команда чтоб установить питоновскую библиотеку :
	```bash
	pip install virtualbox
	```
	
	- Так же для работы этой библиотеки необходимо установить SDK VirtualBox [Ссылка на скачивание SDK](https://download.virtualbox.org/virtualbox/6.1.18/VirtualBoxSDK-6.1.18-142142.zip) . Подробнее описанно в [инструцкции](https://pypi.org/project/virtualbox/)
	


# :raised_hands: Способы связи с компонентом
Данные тесты можно запускать с параметрами в зависимости от того, где находится дистрибутив с установленым нужным компонетом, тест которого проводится

**Поддержанные способы связи:**

- Запуск через локально запущенный docker контейнер 
- Запуск через гостевую сессию виртуальной машины VirtualBox
- Запуск с помощью соединения по TCP\IP
- Запуск с помощью соединения по SSH
- Запуск внутри linux-системы

### Запуск через запущенный docker контейнер
- Для этого способа необходимо **локально** запустить docker контейнер в котором установлен нужный тестируемый.
- Для работы с этим способом необходима установка модуля API для Docker(Команда указана в разделе Зависимости)
- Скрипт подключится через Docker exec в **первый** запущенный контейнер - и будет взаимодействовать с ним

### Запуск через гостевую виртуальную машину VirtualBox
- Для этого необходимо установить SDK Virtual Box, а после установить необходимую библиотеку
- Прописать в настройках нужные параметры (Указано выше)
- Установить гостевые дополнения в виртуальную машину


### Запуск через SSH
- Необходимо установить нужную библиотеку
- Прописать в настройках нужные параметры (Указано выше)
- Установить сервер SSH и в настройках (`sudo vi /etc/ssh/sshd_config`) прописать доступ по логину-паролю локальной учетной записи
   - Пока используется только стандартный порт : 22

### Запуск через TCP\IP
- Для этого способа надо :
	- Правильно прописать настройки для нашего дистрибутива , где находится компонент в файле `settings.ini`:
		- IP адрес в графе `apiaddr`
		- порт  в графе `apiport` нашего дистрибутива , где находится компонент

	- Прописать нужный компонент в параметрах утилиты inetd самого дистрибутива

### Запуск внутри linux-системы

PS - В этой версии тестов 100% рабочий только способ конекта через локальный Docker-контейнер


